# MSA 분해와 통신

> 일반적으로 분해와 통신은 IPC 통신을 통해서 이루었습니다.
> 사실상 **도메인의 분리** 부분에서는 어느정도 만족시키면서 구현하였다.

## 분해, 통신 그리고, 다양한 기교

- 송금 -> 맴버십 데이터 가져오기
- 송금 -> 머니 서비스 요청
- 송금 -> 뱅킹 서비스 통해서 확인
- 이런 작업이 하나의 트랜잭션이 되어야 함
- **현재 셋팅에서는 중간에 트랜잭션 실패시 Failed된 상태로 남게됨**

> 해결방법 : **SAGA Pattern, 2PC, 보상 트랜잭션**을 통해서 일반적으로 해결한다. 혹은 단순 Sync 방식으로 구현하고 재시도 하거나 DB에 상태를 저장하고 이를 비동기 방식으로 재시도 할 수 있다.

## 트랜잭션이 꼭 필요한 케이스

- Risky한 서비스인 금융 시스템의 경우나 외부 의존성에 제약이 있을 경우 **트랜잭션**이 필수적이다.
- 만일, 송금 서비스 도중 money.decrease(fromMember)는 되었으나 money.increase(toMember)는 되지 않는다면?
  - 이는 서비스 장애 및 처벌을 받을 수 있는 사항

**가능하다면, 트랜잭션은 구현하지 않는 것이 바람직 함**  

-> 그 사유는 운영 및 이해하기가 매우 어렵다.

## Transaction과 ACID 속성

- 일련의 작업을 atomic하게 수행하는 작업의 단위
- 트랜잭션은 원자성을 가지게 구현하는것이 필요 충분 조건임
- **Atomicity(원자성)** : 전체가 수행되거나 혹은 수행되지 않거나의 특성을 가져야 함, 모두가 전체로 실패하거나 아니면 성공하거나
- **Consistence(일관성)** : 트랜잭션의 실행 전과 실행 후에 변경되는 데이터는 일관성을 유지하여야 함 (데이터 정합성 유지), Pkey인 ID등이 변경되면 안되겠죠.
- **Isolation (고립성)** : 트랜잭션 간 서로 영향을 미치면 안됨
- **Durability(지속성)** : 트랜잭션 완료 후, 그 **결과는 영구적으로 유지** 되어야 함

## 분산 시스템 환경에서 트랜잭션 유지 방안

### n Phase Commit
- **2 Phase Commit**
- **3 Phase Commit**

### Others
- 보상 트랜잭션
- SAGA Pattern (2PC + 보상 트랜잭션)

---

## What is 2PC (2 Phase Commit)

### 2 Phase Commit

- 처음에는 다수의 노드를 가지는 데이터베이스에서 커밋을 구현하기 위한 개념으로 시작
- 2PC는 일반적으로 약속 규약으로 볼 수 있다.
- Cordinator (조정자 : 인프라)
  - Phase 관리용
- Prepare (준비 1 Phase)
- Commit (커밋 2 Phase)

## 2 Phase Commit Process

> **Start "Prepare"**
> 1. MSA에 트랜잭션으로 묶인 각 서비스에 Cordinator가 Transaction ID를 생성하고 각 서비스에 **준비를 요청합니다.**
> 2. 각각의 서비스가 준비가 되었다고 리턴을 받음  
> 
> **Prepare Done Start "Commit"**  
> 
> 3. Cordinator는 각 서비스에 Commit 요청을 수행합니다.
> 각 서비스들은 이전에 준비했던 동작을 마저 진행후 실제 데이터 변경을 위한 Commit을 수행
> 모든 서비스로 부터 OK 응답을 받으면 트랜잭션 종료

![alt text](../ImageDirectory/2PC%20Process.png)

- 위 그림에서 Participant 1,3만 준비가 완료되었다고 하고 2는 아직 준비되지 않았다고 가정하면
- Cordinator는 1,3 Participant에 모두 Commit 단계에서 abort 처리한다.
- 그리고, 이 1,3은 준비 단계에서 Data Isolation을 지키기 위해서 해당 Data Lock을 걸어야 한다. **(부하가 많이 갈 수 있다.)**

**한계점**
1. Cordinator가 문제가 생기면 모든 트랜잭션은 멈춘다.
2. Data Lock이 걸린 상태에서 Cordinator가 멈추면 최악으로 Data에 접근은 되지 않으며 서비스 장애가 생긴다.
3. Commit과 Abort 결정이 다 수행이 되었지만 그 사이에 문제가 생겼더라면 해결 불가한 문제 생성

## 보상 트랜잭션 (Compensating Transaction)
- **보상 트랜잭션**
  - 커밋된 데이터를 커밋되기 이전 상태로 넘기기 위함
  - DB 개념으로 작업(do)를 다시 Undo 할 때 "보상" (Compensate)라는 용어를 사용
  - 보상 로그 레코드를 참고해서 이전 상태로 복구한다.

## MSA 환경에서 보상 트랜잭션

- DBMS 기준으로는 Commit 된 데이터를 Commit 되기 이전 상태로 변경하는 작업

**MSA**

- "Commit"된 **데이터 변경을 수반하는 요청이 정상적으로 종료된 서비스**에서의 "데이터"를 **API 호출에 대해서** "Commit"되기 이전의 **데이터 변경 요청을 하기 이전의** 상태로 변경하기 위한 작업 **상태로 되돌리기 위한 API**

**한계점** : **보상 트랜잭션 자체의 요청 지연 혹은 실패, 문제가 발생**하는 경우, 보상 트랜잭션을 호출하는 주체는 이 판단이 어려워짐
